<!doctype html>

<html>
  <head>
    <meta charset='utf-8' />
    <meta name="viewport" content="width=device-width, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <title>test - phina.js</title>
    <meta name="description" content="${description}" />

    <script src="http://cdnjs.cloudflare.com/ajax/libs/jade/1.3.1/jade.js"></script>
    <script src="http://rawgit.com/phi-jp/riot/build/dist/riot/riot+compiler.js"></script>
    <script src="http://cdn.rawgit.com/phi-jp/high/0.0.3/high.js"></script>

    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-2.1.4.js"></script>

    <!-- jframe -->
    <script src='http://cdn.rawgit.com/phi-jp/jframe/0.0.1/jframe.js'></script>

    <!-- test helper -->
    <script src='./../game/testhelper.js'></script>
  </head>
  <body>
    <app></app>
  </body>
</html>

<script type='riot/tag' template='jade'>
  app
    div.
      <div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer
                  mdl-layout--overlay-drawer-button">
        <phina-nav sections='{this.sections}'></phina-nav>
        <phina-main></phina-main>
      </div>
    script(type='text/javascript').
      this.sections = opts.sections;
</script>

<script type='riot/tag' template='jade'>
  phina-nav.mdl-layout__drawer
    span.mdl-layout-title phina.js
    nav.mdl-navigation
      div.mdl-navigation__link
        search(oninput='{search}')
      itemgroup(each='{sections.filter(filter)}', data='{this}')
    style.
      div.mdl-navigation__link {
        padding: 0px 10px !important;
      }

    script(type='text/javascript').
      this.sections = opts.sections;

      var searchValue = '';

      this.search = function(event) {
        searchValue = event.target.value;
        this.update();
      };
      this.filter = function(item) {
        if (searchValue) {
          var flag = item.name.indexOf(searchValue);
          return flag !== -1;
        }
        else {
          return true;
        }
      };
</script>

<script type='riot/tag' template='jade'>
  phina-main.mdl-layout__content
    div.page-content
      div#preview(name='preview')
    style.
      phina-main, phina-main div.page-content, phina-main div.page-content #prev iframe {
        height: 100%;
      }
      #preview {
        height: 100%;
      }
      #preview iframe {
        height: 100%;
      }
    script.
      this.on('mount', function() {
        window.preview = jframe("#preview");
      });
</script>

<script>
  riot.compile(function() {
    componentHandler.upgradeDom();
  });

  var hash = location.hash.substr(1);
  var data = {
    sections: [],
  };

  th.load('config.json', function(d) {
    var files = [];
    d.files.each(function(file) {
      files.push(file);
    });

    th.loadScripts(files, function() {
      // // マウントする
      var json = th.toJSON('templates/simple.html?{link}');

      json.forEach(function(s) {
        data.sections.push(s);

        var matchedItems = s.items.filter(function(item) {
          return item.path === hash;
        });

        if (matchedItems.length > 0) {
          var code = (function() {
            var code = th.code(matchedItems[0].path);
            var lines = code.split('\n');
            lines.splice(0, 1);
            lines.splice(lines.length-1, 1);
            return lines.join('\n');
          })();

          var a = $.ajax({
            url: 'templates/display.html',
          });
          a.done(function(res) {
            var html = res.replace('{{code}}', code);
            preview.load(html);
          });

          s.open = true;
        }
      });

      riot.update();
    });
  });

  riot.mount('app', data);

</script>
